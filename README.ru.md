На других языках: [English](README.en.md)

# Puny Switcher #

Скрипт для исправления текста, набранного не в той раскладке, и безусловного переключения раскладок в X11 и GNOME.

## Возможности ##

- Исправление последнего слова / всей строки до курсора / выделенного текста
- Безусловное переключение раскладки: каждому языку свой хоткей
- Буфер обмена сохраняется
- Нет кейлоггинга
- Нет имитации клавиатурного ввода
- Нет мониторинга клавиатуры
- Нет ремаппинга клавиш
- Есть альтернативные версии функций для cистем без GNOME и systemd

## Установка ##

- Установить [расширение для GNOME](https://extensions.gnome.org/extension/6691/shyriiwook) для безусловного переключения раскладки консольной командой ([репозиторий](https://github.com/madhead/shyriiwook)).
- Установить [xsel](http://www.kfish.org/software/xsel/) для манипуляций буфером обмена и выделением ([репозиторий](https://github.com/kfish/xsel)).
- Уcтановить [kanata](https://github.com/jtroo/kanata/) (а именно — версию [`kanata_cmd_allowed`](https://github.com/jtroo/kanata/releases/latest), позволяющую исполнять внешние команды) или любой другой ремаппер клавиатуры, умеющий макросы и вызов внешних команд.
- Разрешить kanata доступ к системе ввода, как описано в [инструкции](https://github.com/jtroo/kanata/blob/main/docs/setup-linux.md).
- Сохранить [скрипт](./puny-switcher.sh) в `~/.local/bin/`. Изучить его содержимое, по необходимости отредактировав.
- Разрешить его исполнение:
```
chmod +x ~/.local/bin/puny-switcher.sh
```
- Сохранить [конфиг для kanata](./kanata/puny-switcher.kbd) в `$XDG_CONFIG_HOME/kanata/` (обычно это `~/.config/kanata/`). Изучить его содержимое, по необходимости отредактировав.
- Сохранить [конфиг для systemd](./kanata/kanata@.service) в `$XDG_CONFIG_HOME/systemd/user/` (обычно это `~/.config/systemd/user/`) для запуска kanata в качестве сервиса.
- Запустить сервис и проверить его состояние:
```
systemctl --user daemon-reload
systemctl --user enable --now kanata@puny-switcher.service
systemctl --user status kanata@puny-switcher.service
```

## Настройка ##

По умолчанию в [конфиге для kanata](./kanata/puny-switcher.kbd) настроены следующие клавиши:
- одиночный левый <kbd>Shift</kbd>: переключить раскладку на первую по счёту
- одиночный правый <kbd>Shift</kbd>: переключить раскладку на вторую по счёту
- двойной <kbd>Shift</kbd>: сконвертировать последнее слово и переключить раскладку
- тройной <kbd>Shift</kbd>: сконвертировать строку до курсора и переключить раскладку
- удержание <kbd>Shift</kbd>: обычное поведение Shift (после таймаута)
- <kbd>Shift</kbd>+<kbd>любая клавиша</kbd>: обычное поведение Shift (сразу)
- <kbd>Pause</kbd>: сконвертировать последнее слово и переключить раскладку
- <kbd>Сtrl</kbd>+<kbd>Pause</kbd>: сконвертировать строку до курсора и переключить раскладку
- <kbd>Shift</kbd>+<kbd>Pause</kbd>: сконвертировать выделенный текст и переключить раскладку

Клавиши можно переопределить в разделе `defsrc` конфига. Например, вместо <kbd>Pause</kbd> можно использовать <kbd>PrtSc</kbd>, заменив там `pause` на `sys`. Список названий клавиш можно посмотреть в функциях `str_to_oscode` и `default_mappings` в [исходнике kanata](https://github.com/jtroo/kanata/blob/main/parser/src/keys/mod.rs).

## Консольные команды ##

```
puny-switcher.sh command [LAYOUT]

commands:
	get					вывести список доступных раскладок, текущую раскладку и её символы
	set LAYOUT_NAME		переключить раскладку на указанную (us|ru)
	iset LAYOUT_INDEX	переключить раскладку на указанную (0|1)
	switch				переключить раскладку на противоположную
	convert				сконвертировать выделенный текст и сохранить результат в буфер обмена
	restore				восстановить прежнее содержимое буфера обмена
```

## Недостатки ##

- Зависит от стороннего ПО
- Не работает в эмуляторах терминала
- Пока умеет переключаться только между английским и русским языками
- Не учитывает варианты раскладок (Дворак, машинопись и т.д.)
- Не проверялось на системах без GNOME и systemd

## Альернативы ##

TODO

## Важное ##

[Queer Svit](https://queersvit.org/) — независимая команда волонтёров со всего мира. С вашей поддержкой мы помогаем ЛГБТК+ сообществу и небелым* людям из Украины, России, Беларуси и других стран региона ВЕЦА. Мы помогаем людям, пострадавшим от войны и/или политических репрессий, оказываем поддержку при переезде — проводим консультации, приобретаем билеты, находим бесплатное жильё и предоставляем гуманитарную помощь.

Война, как и всякая катастрофа, сильнее всего бьет по наиболее уязвимым членам общества. Так, маргинализированные группы (включая ЛГБТК+ и небелых* людей) находятся в большей опасности, но об их проблемах почти общество почти не слышит. Но так как наша команда и состоит из квир- и небелых* людей, мы не понаслышке знаем о трудностях, с которыми сталкиваются наши бенефициары, и хорошо понимаем, как им помочь.

Ваши пожертвования имеют значение; Queer Svit существует в значительной степени за счет небольших пожертвований индивидуальных жертвователей. Мы благодарны за любую помощь — спасибо!

## Лицензия ##

[Hippocratic License 3.0 (HL3-CORE)](https://github.com/roadkell/puny-switcher/blob/main/LICENSE.md)
